# AI憲法.md（ローグライクカードゲーム実装用）

この文書は「実装AIが絶対に破ってはいけない不変条件」と「作業の進め方」を定義する。
この憲法に反する変更を入れた場合、そのPR/差分は却下され、憲法に合わせて作り直す。

---

## 0. 用語（最小）
- **Engine**: 純粋なゲーム進行ロジック（src/engine）。UIに状態更新をさせない。
- **UI**: 描画と入力（src/ui, src/app）。状態を直接変更しない。
- **State**: 進行に必要な全データ。UIは参照のみ。
- **Step**: `Engine.step(envelope)` の1回呼び出しで発生する状態遷移。
- **Scene**: 画面レベルの状態（Title / SaveSelect / Hub / Battle …）。
- **Battle**: 戦闘シーン内部のフェーズ進行（Read/Plan/Execute…）。
- **TimelineIcon**: タイムライン上の予約行動（唯一の行動モデル）。
- **SlotEffect**: TimelineIconに貼る“一時干渉”。Statusとは別系統。
- **Status**: キャラに貼り付く状態異常。Triggerで反応する。
- **ExecutionLog**: 「状態は確定してるがUIは順番に見せたい」ための再生用ログ。

---

## 1. アーキテクチャ不変条件（破ったら即NG）
### 1.1 UIはstateを直接変更しない
- UIは `Engine.step(actionEnvelope)` を呼び、戻り値の `nextState` を描画するだけ。
- UI側で状態更新（手札減らす、HP減らす、CT変える等）をしてはいけない。

### 1.2 戦闘解決は一本化（即時実行禁止）
- 戦闘の効果処理は必ず **Event → Intent → Resolve → Execute** の順。
- ダメージ/CT変更/状態付与などの副作用は **Execute** 以外で起こしてはいけない。
- 「使った瞬間にHPが減る」等の即時実行は禁止。必ずキューを通す。

### 1.3 TimelineIcon.ct が唯一の真実
- 行動順・残りCTは TimelineIcon.ct を真とする。
- UI表示用にCTを別管理したり、二重化して整合を取る実装は禁止。

### 1.4 RNGは分離し、再現可能であること
- RNGは最低でも `runRng / battleRng / uiRng` に分離する。
- `battleRng` は seed+ログで完全再現できなければならない。
- UI演出のランダム（揺れ等）は `uiRng` で行い、進行に影響させない。

### 1.5 セーブ/ロードは schemaVersion + migrate 前提
- SaveFileは schemaVersion を持つ。
- schema変更は migrate を必ず追加する。
- 戦闘中セーブは禁止（復帰点は仕様のチェックポイントに従う）。

---

## 2. 実装ルール（AIの暴走防止）
### 2.1 “勝手に新概念”を増やさない
- 新しい大枠概念（新フェーズ、新サブシステム、新しい状態管理）を勝手に導入しない。
- 既存の命名・フォルダ境界・型を尊重し、必要最小限の追加に留める。

### 2.2 public APIは最小
- UI↔Engineの境界（Engine.index.ts）はなるべく増やさない。
- 迷ったら内部関数に閉じ込め、後で必要になったら公開する。

### 2.3 変更範囲を宣言してから作業する
- そのタスクで触るファイル/ディレクトリを先に宣言し、それ以外は触らない。
- “ついでのリファクタ”は禁止（別タスクに切り出す）。

### 2.4 テスト or 決定性ログは必須
- Engineのロジック変更は Vitest を最低1本追加/更新する。
- テストが難しい場合は「同じseedで同じログになる」決定性ログ手順を必ず提供する。

---

## 3. Done（完了条件）テンプレ
各タスクの完了は、最低でも以下を満たすこと。

- [ ] 変更ファイル一覧
- [ ] 仕様上の根拠（どの仕様項目を実装したか。章タイトルでOK）
- [ ] テスト（Vitest）1本以上、または決定性ログ手順
- [ ] 主要な型/関数のI/Oが分かる短い説明（3〜8行）
- [ ] 受理表（acceptTable）がある場合、許可/拒否が意図通り

---

## 4. 今回の実装スタイル（推奨）
- 実装は「小さい縦スライス」で進める。1タスクは変更10ファイル未満を目安。
- “一気に全部”は不可。Scene遷移 → 戦闘最小 → 拡張の順で進める。
- 1タスクで「UIとEngine両方を大きく作る」ことは避ける（片方を薄く）。

---

## 5. 出力フォーマット（AIが返すべき形）
AIは作業結果を以下の順で返すこと。

1) 目的（1〜2文）
2) 変更概要（箇条書き）
3) 変更ファイル一覧
4) テスト/確認方法
5) 仕様の根拠（章タイトル or ファイル名）

この憲法を毎回の作業の最初に読み、矛盾があれば実装を止めて報告する。
