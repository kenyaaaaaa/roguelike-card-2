# 戦略的ローグライクカードゲーム 完全仕様書

本書は、ゲームの全仕様（基本設計・UI/エンジン契約・セーブ/ロード・戦闘/CT/タイムライン・Status/SlotEffect・数値裁定・プレイヤー/敵定義）を網羅した**唯一の正本**である。

---

## 0. 基本思想（最重要）

### 0.1 設計原則

- **状態の唯一の更新者はエンジン**。UIは状態を直接変更しない
- すべての効果は **Event → Intent → Resolve → Execute** の一本化された流れを通す
- **即時実行は禁止**。CT・ダメージ・状態更新は必ずキュー経由で確定する
- **TimelineIcon.ct が唯一の真実**。表示や理由付けは注釈（SlotEffect / executionLog）で行う
- 再現性・デバッグ性を最優先し、RNG・CT・チェックポイントを明示的に管理する

### 0.2 全体構成（シーンレベル）

ゲームは以下の3層で構成される：

1. **ラン前**：タイトル / セーブ選択 / 拠点
2. **ラン中**：エリア進行（戦闘・イベント・店・祠 等）
3. **ラン後**：結果表示 / 永続成長

画面遷移の真実は `GameState.scene` のみ。Pauseは Scene を変えず `ui.modal = 'PAUSE'` として表現する。

---

## 1. ターンの進行フロー

バトルは以下の5つのフェーズをループして進行する。

### ① 情報フェーズ（Read）

- **内容**: 敵の次の行動（Move）・意図（Intent）の表示
- **プレイヤー**: 手札、FP、APの状態を最終確認する
- **備考**: このフェーズではリソース消費やカードの使用は行われない

### ② 計画フェーズ（Plan）

全てのプレイヤー入力をこのフェーズで処理する。

- **できること**:
  - FPを消費してカードを使う
  - APを消費してアビリティを使う

- **解決のルール**:
  1. **インスタント（即時）**: 使った瞬間に効果が解決。手札やFPが変わった状態から、さらに続けて次の選択が可能
  2. **CT（予約）**: コストを支払い、タイムライン上にアイコンを予約。効果の発動は「実行フェーズ」まで保留される

- **実装上の注意**: 
  - UIは入力を `UIActionEnvelope` として送信（clientSeq付き）
  - エンジンは即時確定せず、Intentとして蓄積
  - `BATTLE_END_PLAN` を受けた時点で **自動Execute** が走る

### ③ 干渉フェーズ（Distortion）

- **内容**: 一部の敵やボスによる割り込み・特殊反応
- **備考**: プレイヤーがPhase 2で確定させた未来に対し、敵が対抗手段を講じる唯一のタイミング。ここで再びタイムラインが変動する場合がある
- **実装**: ボス専用のタイムライン干渉処理

### ④ 実行フェーズ（Execute）

- **内容**: タイムライン上のアイコンが左（0）へ向かって進み、CTが0に到達した順に予約済みの効果を発動する
- **制限**: 原則としてアビリティの使用や割り込みは不可
- **実装**: CT=0 Icon を順に解決。executionLog を生成

### ⑤ 後処理フェーズ（Cleanup）

- **内容**: 
  - 状態異常のカウント減少
  - ブロック（防御値）の減衰
  - 敵AIの次ターンの行動決定
  - 手札処理：プレイヤー手札は原則すべて捨て札に送られる
    - 例外：カード効果・アビリティ・状態によって「保留」されたカードのみ手札に残る
  - 勝敗判定

- **備考**: 全ての処理を終え、次のターンの「情報フェーズ」へ移行する

---

## 2. バトルシステム：CT（チャージタイム）ロジック

### 2.1 TimelineIcon（統一行動モデル）

プレイヤー行動 / 敵行動 / 必殺 / アビリティ を完全同型で扱う。すべての行動は TimelineIcon として表現される。

### 2.2 タイムラインUI

- **進行方向**: 左から右へ流れるバー
- **0地点**: バーの左端。アイコンがここに到達した瞬間にアクションが実行される
- **表示情報**: 敵・味方のアイコンと、その真下に**「実行CT」**の数値を表示
- **予測表示（ゴースト）**: 手札のカードにホバーすると、使用後のアイコン到達予定位置に半透明のゴーストが表示される

### 2.3 同CT到達時の行動順（固定）

タイムラインは常に以下のソートキーで決定する：

```
sortKey = (ct 昇順, ownerPriority, createdSeq 昇順)
```

- `ownerPriority` は player < enemy（プレイヤー優先）
- `createdSeq` は初回配置時に付与し、ct編集やswapでは変更しない
- 同キーなら id 昇順（保険）

### 2.4 CT計算式（予約時）

プレイヤーの敏捷性とカードの重さによって、リアルタイムに行動順が計算される。敵も同様にspeedとctをもつ。

```javascript
scheduledCt = max(
  definition.minCt ?? 0,
  baseCt * 100 / (100 + speed)
)
```

- **baseCt**: 技そのものの重さ（カードCT / 敵ActionのbaseCt）
- **speed**:
  - プレイヤー → 敏捷
  - 敵 → enemySpeed
- **minCt**: その技の下限CT（なければ0扱い）

👉 プレイヤーと敵で式は完全に同じ

### 2.5 CTクランプ（唯一の正解）

すべてのCT変更は以下の式を必ず通す：

```javascript
clampedCt = max(
  proposedCt,
  icon.minCtFrozen ?? 0,
  battleRules.ctFloorThisTurn ?? 0
)
```

### 2.6 Speed修正とCT操作の責務分離

#### Speed修正

- **Slow/Haste（状態異常）** は speed に掛ける（デフォルト）
- **時間操作（スキル/歪曲）** は CT に直接触る（"例外"として少数）
- Speed修正（Haste / Slow）は、CT計算時にのみ参照される
- 計算後に生成されたタイムラインアイコンは、不変とする
- タイムラインの並びを変更できるのは、CTを直接操作する効果のみ

#### CT操作

- 対象は タイムライン上の予約アイコン（Queued Icon）
- 変更できるのは アイコンの残りCT（表示CT）だけ（効果そのものや対象は変えない）
- 変更は Planフェーズのインスタント または Distortionフェーズ でのみ発生（Execute中は原則なし）
- 変更後は即座に並び替え（CT昇順、同CTは既定のタイブレーク）
- CTはクランプ：`ct = max(minCt, ct + delta)`（minCtが無いなら0）

---

## 3. プレイヤーのリソース

| リソース名 | 回復タイミング | 初期値 | 最大値（周回後） | 役割 |
|---|---|---|---|---|
| HP | ステージ報酬・休息 | 100 | 200 | 生存限界値。0になるとゲームオーバー |
| FP (Focus Point) | 毎ターン全回復 | 3 | 3（固定） | カードを使用するための基本エネルギー |
| AP (Ability Point) | 原則、戦闘中回復なし | 3 | 6 | タイムライン干渉などの強力なアビリティの弾数 |
| ゴールド (Gold) | 回復なし（ラン中に増減） | 0 | 上限なし | 商店・イベントで使用する通貨。拡張により戦闘中に参照・増減される場合がある |

### 3.1 ゴールド（Gold）に関する補足

- **種別**：ラン内通貨（Run Currency）
- **持ち越し**：同一ランの戦闘間で保持される（周回を跨いで保持しない）
- **性質**：
  - FP / AP のような「ターン制リソース」ではない
  - ターン開始・終了によるリセットは行われない
- **戦闘中の扱い（拡張前提）**：
  - 戦闘中に増減・参照される場合がある
  - その場合、必ず明示的な効果（Effect）として処理される
  - ゴールド量に依存する効果は、上限または逓減を設けることを推奨する

---

## 4. コンテンツ・タイプ

### 4.1 カード (Cards)

- **コスト**: FPを消費

#### 種別

**CTカード（メインアクション）**
- **内容**: 攻撃、防御、大技、強力なデバフ
- **性質**: 敏捷性の影響を直接受け、タイムラインにアイコンが乗る。実行フェーズ（Phase 4）で解決

**インスタントカード（セットアップ）**
- **内容**: ドロー、手札交換、FP回復、コスト軽減、手札バフ
- **性質**: 敏捷性の影響を受けず、計画フェーズ（Phase 2）内で即座に解決される

#### アップグレード

##### 基本ルール

1. **Upgradeは原則「1回だけ」**
   - base → base+（+表記）
   - 例外で"分岐進化"は後から追加できるが、最初は封印

2. **Upgradeは「差分パッチ」で表現する**
   - カード定義を丸ごと複製しない
   - 差分だけ持たせる（実装と保守が楽）

3. **触っていいのは4カテゴリだけ**
   - 数値（damage/block/stacks等）
   - コストFP
   - CT系（baseCt / minCt）
   - 効果1個の追加（例：ドロー+1、状態+1など）

##### Upgradeの強化軸

推奨比率：
- 60%：数値アップ（分かりやすい）
- 25%：CT改善（回転の体感が変わる）
- 10%：コスト改善（強いけど希少）
- 5%：効果追加（派手枠）

##### CT強化の安全ルール（重要）

**ルールA：CTは「一段階だけ」**
- baseCt -10 とか -15 まで
- それ以上は 効果追加か数値に逃がす

**ルールB：minCtは"下げない"が基本**
- minCtを下げると「踏み倒し」が暴走する
- minCtはむしろ 上げる（安全弁） のに使う方が多い
- （例：強化で威力上げる代わりに minCt+5 とか）

#### 祠システム

「祠」ステージにて、1枚だけ次回のラン（周回後）に初期デッキとして持ち越せる

### 4.2 アビリティ (Abilities)

- **コスト**: APを消費
- **特徴**: 戦況を劇的に変える効果
- **獲得**: 特別なステージ（試練など）で入手

#### 種別

**原則：インスタント（9割）**
- **役割**: タイムラインの操作（スワップ、遅延、加速）
- **性質**: 使った瞬間に未来（タイムラインの並び）が書き換わる

**例外：Scheduled / 必殺技（1割）**
- **役割**: 環境改変、儀式、超極大ダメージ
- **性質**: タイムラインに予約され、CTが0になるまで発動を待つ

### 4.3 レリック (Relics)

- **特徴**: 常時発動するパッシブ効果
- **入手**: エリート敵、商店、ミニゲーム

### 4.4 アイテム (Items)

- **特徴**: 1ターンに何度でも使用可能な消費型ツール
- **入手**: 敵ドロップ、商店、ミニゲーム

---

## 5. ステージ構成とエリア進行

- **1エリア**：約30ステージの一本道（ランダム要素あり）

### 5.1 出現要素

- **敵 / エリート**
  - 勝利時にゴールドを獲得
  - 一部の戦闘では、追加でカード・レリックなどの特別報酬が提示される
- **商店**
  - ゴールドを消費して以下を行う
    - カードの購入
    - カードの削除
    - レリックの購入
    - アイテムの購入
- **祠**
  - 特定条件下でカードを次周回へ持ち越す
- **ミニゲーム**
  - ゴールドや特殊報酬を獲得できる
- **強化ステージ**
  - カード性能の底上げを行う

### 5.2 ゴールドの獲得と消費

#### 主な獲得手段
- 戦闘勝利報酬
- エリート敵の撃破
- イベント・ミニゲーム

#### 主な消費先
- 商店での購入・削除・強化
- 特定イベントでの選択肢コスト

### 5.3 ゴールドと戦闘の関係（拡張仕様）

ゴールドは原則として戦闘外で使用されるが、以下のような拡張を許容する設計とする：
- 敵がプレイヤーのゴールドを奪う／消費させる
- 所持ゴールド量に応じて、攻撃力・防御力・状態異常の効果量が変動する
- ゴールドを消費することで、戦闘中に特殊効果を発動する

これらの処理はすべて「効果（Effect）」として明示的に定義し、暗黙的な常時補正は行わない。

### 5.4 戦闘報酬

#### 宝箱（Battle Reward Chest）
戦闘勝利時、必ず宝箱が出現する。

#### 毎回必ず得られるもの
- **ゴールド（Gold）**
- **ソウル（Soul）**

これらは全ての戦闘で必ず獲得できる基本報酬とする。

#### カード報酬

カード報酬は常時発生しない。戦闘タイプに応じて、以下のルールで提示される。

**通常戦**
- **5回に1回**、カード報酬が発生する
- 発生しない場合でも、ゴールドとソウルは必ず獲得できる

**エリート戦**
- 以下のいずれかを提示する
  - **カード報酬**
  - **レリック報酬**
- どちらが提示されるかはランごとに変化する

**ボス戦**
- 以下のいずれか、または両方を提示する
  - **高レアカード**
  - **レリック**

#### カード提示形式

カード報酬が発生した場合、以下の形式で提示される：

- **3枚のカード候補から1枚を選択**
- **スキップ可能**

※ スキップは明示的な選択肢として常に表示される  
※ スキップすることでデッキを肥大化させない判断も戦略の一部とする

---

## 6. 周回強化要素（メタ進行）

各キャラクターごとに独立して保存される永続強化項目。

| 項目 | 上昇値/Lv | 最大Lv | 最大効果 |
|---|---|---|---|
| 最大HP | +5 | 20 | HP +100 |
| 基本攻撃力 | +2% | 15 | ダメージ +30% |
| 敏捷性 | +2 | 25 | 敏捷性 +50 |
| AP上限 | +1 | 3 | AP 3 → 6 |
| アビリティ枠 | +1 | 2 | 枠 2 → 4 |
| 祠の持ち越し枠 | +1 | 2 | 持ち越し 1 → 3枚 |

---

## 7. 初期キャラクター・アーキタイプ（抜粋）

- **ルカ (Luka)**: 「速度操作」を得意とし、CTスワップで大技を高速化させる
- **疫病師 (Plaguebearer)**: 「敵の遅延」に特化。デバフを育てて崩壊させる
- **吸血候 (The Bloodlord)**: 「自傷と加速」。HPを削り、圧倒的な敏捷性を一時的に獲得

---

## 8. UI / エンジン契約

### 8.1 役割分担

**UI**
- GameState を描画するだけ
- 入力を `UIActionEnvelope` として送信（clientSeq付き）
- Engine requests（SAVE / SFX / Toast 等）を実行
- executionLog を順番に再生（スキップ可）

**エンジン**
- `step()` による状態遷移（純粋関数志向）
- 不正 Action の reject
- RNG / clientSeq / SAVE_RUN の管理
- 戦闘 Execute の自動解決と executionLog 生成

### 8.2 clientSeq（二重送信対策）

- UI側で単調増加
- Engine は `lastProcessedSeq` を保持
- 同一 seq は **状態不変・副作用なし**で返す

---

## 9. セーブ / ロード（戦闘中セーブなし）

### 9.1 方針

- 保存対象は **ラン状態まで**
- 戦闘中は保存しない
- クラッシュ時は **戦闘開始前（PRE_BATTLE）** に巻き戻す

### 9.2 チェックポイント

- MAP / PRE_BATTLE / POST_BATTLE / EVENT / SHOP
- PRE_BATTLE には battleSeed / callIndex を必ず保持

---

## 10. Status と SlotEffect の分離

| 項目 | Status | SlotEffect |
|---|---|---|
| 貼り先 | キャラ | TimelineIcon |
| 寿命 | duration / stack | Iconが消えるまで |
| Trigger | あり | なし |
| 再発火 | あり | なし |
| 用途 | 病気・体質 | 時間干渉の注釈 |

### 重要事項

- **SlotEffect は注釈専用**
- SlotEffect から CT を再計算してはならない
- CTの真実は常に TimelineIcon.ct

---

## 11. Effect 解決モデル

すべての効果は以下のフローを通す：

1. **Event 発生**
2. **Reaction 収集** → IntentEffect
3. **Resolve**（確定値を計算）
4. **Execute**（状態反映・副作用）
5. **新Event 発生**

**直接 state を書き換える処理は禁止**。

---

## 12. ダメージ / 防御裁定

### 12.1 適用順

1. 攻撃側 modifier（Weak / 周回強化 等）
2. 防御側 modifier（Vulnerable 等）
3. Block
4. Armor
5. HP

### 12.2 Block / Armor

- **Block**：ターン終了で消滅
- **Armor**：消費型の盾（DoT含め軽減）

---

## 13. 同CT・死亡・キャンセル

- sortKey：`(ct, ownerPriority, createdSeq)`
- HP<=0 になった瞬間、そのキャラの未実行Iconは全キャンセル

---

## 14. プレイヤー設計（抜粋）

- 恒常STRは存在しない
- 火力成長は **攻撃側% modifier** としてのみ扱う
- 「次の攻撃」系は消費型Statusで表現

（詳細は Player / Card 定義に委譲）

---

## 15. 敵設計（抜粋）

- 敵行動もすべて TimelineIcon
- baseCt は 18 / 28 / 40 / 55 を基準
- 複数回行動は **別Icon複数回** が原則

---

## 16. executionLog（UI演出用）

- seq 連番で返却
- UI はそのまま再生するだけ
- スキップ時は残りを即時消化

---

## 17. 本書の位置づけ

- 本仕様書は **唯一の正本**
- 個別仕様（敵/キャラ/カード）は本書に反しない範囲で追加する
- 迷ったら「再現性・単一真実・即時実行禁止」を優先する

---

以上。